{"metadata":{"guid":"7a9edc64-a0d3-4ef4-aebb-f6ac32ef32ca","url":"/v2/streaming_pipelines/7a9edc64-a0d3-4ef4-aebb-f6ac32ef32ca","created_at":"2018-02-22T12:21:36Z","updated_at":"2018-02-22T12:24:16Z","revision":1519302256510},"entity":{"name":"retail-streaming-prebuilt","description":"Streams Designer flow created as part of the Retail Streaming demo\nhttps://github.com/ibm-cloud-streaming-retail-demo/wdp-streams-designer-ml-alert","project_guid":"9398a8fd-6579-4891-a156-b23a1eb32bb3","graph":{"doc_type":"pipeline","version":"1.0","json_schema":"http://www.ibm.com/ibm/wdp/flow-v1.0/pipeline-flow-v1-schema.json","id":"","app_data":{"ui_data":{"name":"retail-streaming-prebuilt"}},"primary_pipeline":"primary-pipeline","pipelines":[{"id":"primary-pipeline","runtime":"streams","nodes":[{"id":"messagehub_c317msbt6hj","type":"binding","op":"ibm.streams.sources.messagehub","outputs":[{"id":"target","schema_ref":"schema0","links":[{"node_id_ref":"code_ml_v7898qeyrxk","port_id_ref":"source"}]}],"parameters":{},"app_data":{"ui_data":{"label":"Message Hub","x_pos":190,"y_pos":400}}},{"id":"code_ml_v7898qeyrxk","type":"execution_node","op":"ibm.streams.operations.code-ml","outputs":[{"id":"target","schema_ref":"schema1","links":[{"node_id_ref":"objectstorage_v2_vo731t81zy","port_id_ref":"source"},{"node_id_ref":"freeform_filter_rdtbbqs7g3","port_id_ref":"source"}]}],"parameters":{"code":"import sys\nimport os\nimport pickle\nimport numpy as np\nimport sklearn\nimport pandas as pd\nfrom collections import OrderedDict\n\ndef process(event, state):\n    \n    transaction_id = event['TransactionID']\n    tx_datetime = event['InvoiceDate']\n    \n    customer_id = event['CustomerID']\n    quantity = event['Quantity']\n    price = event['UnitPrice']\n    \n    data = np.array([[price, quantity, customer_id]])\n    \n    predict_prob = state['logistic_model'].predict_proba(data)\n    \n    prob_cancelled = predict_prob[0][1]\n    \n    prediction =  OrderedDict([    \n            ('transaction_id', transaction_id),\n            ('invoice_date',   tx_datetime),\n            ('prob_cancelled', prob_cancelled)\n            ])\n            \n    return prediction\n\n\ndef load_logistic_model(state, path_logistic_model):\n\tstate['logistic_model'] = pickle.load(open(path_logistic_model, 'rb'))","schema_mapping":[{"name":"transaction_id","type":"double","length":0,"source_elem_name":"","target_elem_name":""},{"name":"invoice_date","type":"double","length":0,"source_elem_name":"","target_elem_name":""},{"name":"prob_cancelled","type":"double","length":0,"source_elem_name":""}]},"app_data":{"ui_data":{"label":"Python Machine learning","x_pos":410,"y_pos":400}}},{"id":"objectstorage_v2_vo731t81zy","type":"binding","op":"ibm.streams.targets.objectstorage_v2","parameters":{"write_policy":"numberOfEvents","rolling_number_of_events":"100000"},"app_data":{"ui_data":{"label":"Cloud Object Storage","x_pos":640,"y_pos":400}}},{"id":"freeform_filter_rdtbbqs7g3","type":"execution_node","op":"ibm.streams.operations.freeform-filter","outputs":[{"id":"target","schema_ref":"schema2","links":[{"node_id_ref":"objectstorage_v2_5wimiiv6o97","port_id_ref":"source"},{"node_id_ref":"mail_juv5upofbzm","port_id_ref":"emailPort"}]}],"parameters":{"expression":"prob_cancelled >= 0.65"},"app_data":{"ui_data":{"label":"Filter","x_pos":640,"y_pos":320}}},{"id":"objectstorage_v2_5wimiiv6o97","type":"binding","op":"ibm.streams.targets.objectstorage_v2","parameters":{"write_policy":"numberOfEvents","rolling_number_of_events":"2000"},"app_data":{"ui_data":{"label":"Cloud Object Storage","x_pos":850,"y_pos":320}}},{"id":"mail_juv5upofbzm","type":"binding","op":"ibm.streams.targets.mail","parameters":{"username":"692bd493292b4f4ead9d805c448f7f1c"},"app_data":{"ui_data":{"label":"Email","x_pos":850,"y_pos":240}}}]}],"schemas":[{"id":"schema0","fields":[]},{"id":"schema1","fields":[{"name":"transaction_id","type":"double"},{"name":"invoice_date","type":"double"},{"name":"prob_cancelled","type":"double"}]},{"id":"schema2","fields":[{"name":"transaction_id","type":"double"},{"name":"invoice_date","type":"double"},{"name":"prob_cancelled","type":"double"}]}]},"engines":{"streams":{"instance_id":"cf9c75e6-46e8-49a6-b983-c724a1f92abc"}}}}